Map_vote_count = {}
Mscount = 0
function ChatMessageHandler(sender_id, sender_name, message)
print(message)
if  string.find(message, "/vote ") then 
    local startind, endind= string.find(message, "/vote")
          local cutoff = string.sub(message, endind+2, message.length)
 if string.find(cutoff, "start") then
               ExecCommand("trackselect", true)
               MP.CreateEventTimer("lockMap", 60000, MP.CallStrategy.BestEffort)
               -- start timer and take map requests, after timer runs out, selct highest voted map and restart the server using ./BeamNGEdit restart

else
   
  
  Map_vote_count[tonumber(cutoff)] = Map_vote_count[tonumber(cutoff)] + 1

end
      

end 

end

function ExecCommand(commPass, boo)
    local command = "/BeamNGEdit {r}"
        command  = command:gsub('{r}',commPass)
if boo then Mscount = 0 end 
        for line in os.capture(command, true):gmatch("[^\r\n]+") do 
        MP.SendChatMessage(-1, line )
       if boo then  Mscount = Mscount+1 end 
        end
        if boo then
        for i = 0, Mscount -2 do 
            Map_vote_count[i] = 0
        end
        end 
end


function os.capture(cmd, raw)
    local f = assert(io.popen(cmd, 'r'))
    local s = assert(f:read('*a'))
    f:close()
    if raw then return s end
    s = string.gsub(s, '^%s+', '')
    s = string.gsub(s, '%s+$', '')
    s = string.gsub(s, '[\n\r]+', ' ')
    return s
  end

function lockMap(map_vote_count)

    MP.CancelEventTimer("lockMap")
local highest = 0
for i = 0, Mscount -1 do
if tonumber(Map_vote_count[i]) > tonumber(Map_vote_count[highest]) then 
    highest = i 
end 
end
local comm = "trackselect {n}"
local comm = comm:gsub('{n}', tostring(highest))
    ExecCommand(comm, false)
end



MP.RegisterEvent("lockMap", "lockMap")
MP.RegisterEvent("onChatMessage","ChatMessageHandler")